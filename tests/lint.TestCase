#!/usr/bin/env python3

# http://www.drdobbs.com/testing/unit-testing-with-python/240165163

import inspect
import os
import shutil
import tempfile
import testbase


import fdroidserver.common
import fdroidserver.lint


class LintTest(testbase.TestBase):
    '''fdroidserver/lint.py'''

    def test_check_for_unsupported_metadata_files(self):
        config = dict()
        fdroidserver.common.fill_config_defaults(config)
        config['accepted_formats'] = ('txt', 'yml')
        fdroidserver.common.config = config
        fdroidserver.lint.config = config
        self.assertTrue(fdroidserver.lint.check_for_unsupported_metadata_files())

        tmpdir = os.path.join(self.localmodule, '.testfiles')
        tmptestsdir = tempfile.mkdtemp(prefix=inspect.currentframe().f_code.co_name, dir=tmpdir)
        self.assertFalse(fdroidserver.lint.check_for_unsupported_metadata_files(tmptestsdir + '/'))
        shutil.copytree(os.path.join(self.localmodule, 'tests', 'metadata'),
                        os.path.join(tmptestsdir, 'metadata'),
                        ignore=shutil.ignore_patterns('apk', 'dump', '*.json'))
        self.assertFalse(fdroidserver.lint.check_for_unsupported_metadata_files(tmptestsdir + '/'))
        shutil.copy(os.path.join(self.localmodule, 'tests', 'metadata', 'org.adaway.json'),
                    os.path.join(tmptestsdir, 'metadata'))
        self.assertTrue(fdroidserver.lint.check_for_unsupported_metadata_files(tmptestsdir + '/'))


if __name__ == "__main__":
    LintTest.main()
